# 周期性任务功能说明

## 功能概述

周期性任务功能允许用户创建重复性的任务，如每日、每周或每月的任务。这些任务不使用传统的进度百分比，而是通过检查当前周期内是否有进展记录来判断完成状态。

## 主要特性

### 1. 任务类型
- **普通任务**: 使用进度百分比（0-100%）来跟踪完成情况
- **周期性任务**: 通过进展记录来标记当前周期的完成状态

### 2. 周期类型
- **每日任务** (`daily`): 每天重置，检查今天是否有进展记录
- **每周任务** (`weekly`): 每周重置（周一到周日），检查本周是否有进展记录  
- **每月任务** (`monthly`): 每月重置，检查本月是否有进展记录

### 3. 状态显示
- **普通任务**: 显示进度条和百分比
- **周期性任务**: 显示当前周期的完成状态
  - ✅ "今日已完成" / "本周已完成" / "本月已完成"
  - ❌ "今日未完成" / "本周未完成" / "本月未完成"

## 数据库设计

### Plan表新增字段
```sql
is_recurring     BOOLEAN  DEFAULT false    -- 是否为周期性任务
recurrence_type  STRING                    -- 周期类型: daily/weekly/monthly  
recurrence_value STRING                    -- 周期值（预留字段，可用于更复杂的周期设置）
```

### 完成状态判断逻辑
周期性任务通过检查 `ProgressRecord` 表中当前周期内的记录来判断是否完成：

```javascript
// 每日任务：检查今天是否有进展记录
// 每周任务：检查本周（周一到周日）是否有进展记录
// 每月任务：检查本月是否有进展记录
```

## 使用方法

### 1. 创建周期性任务
1. 在计划管理页面，勾选"这是一个周期性任务"
2. 选择周期类型（每日/每周/每月）
3. 填写任务名称、描述等信息
4. 保存任务

### 2. 标记任务完成
1. 进入任务的进展页面
2. 添加一条进展记录
3. 系统会自动将该任务标记为当前周期已完成

### 3. 查看任务状态
- 在计划列表中，周期性任务会显示特殊的状态标识
- 类型列显示周期类型（每日/每周/每月）
- 状态列显示当前周期的完成情况

## API接口

### 创建周期性任务
```javascript
POST /api/plan
{
  "name": "每日锻炼",
  "description": "每天至少锻炼30分钟", 
  "difficulty": "medium",
  "is_recurring": true,
  "recurrence_type": "daily",
  "tags": ["健康", "运动"]
}
```

### 添加进展记录
```javascript
POST /api/progress_record
{
  "plan_id": "plan_xxx",
  "content": "今天跑步30分钟",
  "thinking": "感觉很好，明天继续"
}
```

## 工具函数

### `recurring-utils.ts`
- `getCurrentPeriodStart()`: 获取当前周期开始时间
- `getCurrentPeriodEnd()`: 获取当前周期结束时间  
- `isRecurringTaskCompleted()`: 判断周期性任务是否完成
- `getRecurringTaskStatus()`: 获取任务状态描述
- `getRecurrenceTypeDisplay()`: 获取周期类型显示名称

## 示例场景

### 每日任务示例
- **任务**: 每日锻炼
- **周期**: daily
- **完成条件**: 今天添加任何进展记录
- **状态**: "今日已完成 ✓" 或 "今日未完成"

### 每周任务示例  
- **任务**: 周报总结
- **周期**: weekly
- **完成条件**: 本周（周一到周日）添加任何进展记录
- **状态**: "本周已完成 ✓" 或 "本周未完成"

### 每月任务示例
- **任务**: 月度财务报表
- **周期**: monthly  
- **完成条件**: 本月添加任何进展记录
- **状态**: "本月已完成 ✓" 或 "本月未完成"

## 优势

1. **简化管理**: 不需要手动重置任务或调整进度
2. **自动周期**: 系统自动根据时间判断当前周期
3. **灵活记录**: 通过进展记录提供丰富的完成信息
4. **清晰状态**: 直观显示当前周期的完成状态
5. **历史追踪**: 保留所有历史进展记录，便于回顾

## 技术实现

- **前端**: React + TypeScript，响应式UI设计
- **后端**: Next.js API Routes + Prisma ORM
- **数据库**: PostgreSQL
- **状态管理**: 基于时间的周期计算和进展记录检查 